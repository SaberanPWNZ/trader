# Виправлення захисту портфеля

## Проблема

Грід-бот зазнав збитків **-44% (-$2208)** через:

1. ❌ **Захист портфеля був ВИМКНЕНО** (`enable_portfolio_protection: False`)
2. ❌ **Немає обмеження на кількість відкритих позицій** (було 21 позиція)
3. ❌ **Немає резерву готівки** (баланс впав до $2412 з $5000)
4. ❌ **Stop-loss 10%** - занадто великий поріг

## Що сталось

### 03.02.2026
- Портфель виріс до $5140.96 (+2.82%)
- 21 купівля, 13 продажів

### 04.02.2026
- Ринок впав, бот продовжував купувати
- 27 купівель на $3375
- 15 продажів на $1895
- Готівка впала з $4018 до $2412
- **21 відкрита позиція вартістю $379 (куплені за $2587)**
- Портфель впав до $2791.68 (-44.17%)

## Виправлення

### 1. Увімкнено захист портфеля
```python
enable_portfolio_protection: bool = True  # було False
```

### 2. Зменшено поріг stop-loss
```python
portfolio_stop_loss_percent: float = 5.0  # було 10.0
max_unrealized_loss_percent: float = 3.0  # було 5.0
```

### 3. Додано обмеження на позиції
```python
max_open_positions: int = 15  # максимум 15 відкритих позицій
min_cash_reserve_percent: float = 40.0  # мінімум 40% готівки
max_position_cost_percent: float = 3.0  # максимум 3% на одну позицію
```

### 4. Додано перевірки перед купівлею

В `grid_simulator.py`:
- ✅ Перевірка кількості відкритих позицій
- ✅ Перевірка мінімального резерву готівки
- ✅ Перевірка розміру позиції відносно портфеля

## Як це працюватиме

1. **При -3% unrealized loss** - попередження, моніторинг
2. **При -5% загального портфеля** - автоматичне закриття всіх позицій (stop-loss)
3. **Максимум 15 позицій** - якщо вже 15, нові купівлі блокуються
4. **Мінімум 40% готівки** - якщо менше, нові купівлі блокуються
5. **Максимум 3% на позицію** - великі позиції блокуються

## Результат

Тепер система:
- ✅ Зупинить торгівлю при -5% збитку
- ✅ Не витратить всю готівку
- ✅ Обмежить кількість ризикових позицій
- ✅ Захистить від великих збитків

## Рестарт

Система перезапущена з новими налаштуваннями:
```bash
docker restart crypto-trading-bot
```

Всі зміни активні з 04.02.2026 20:50 UTC.
